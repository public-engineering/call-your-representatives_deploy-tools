<!DOCTYPE html>
<html>
  <head>

      <title>
      Call Your Representatives!
    </title>


    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://josephmarhee.com/assets/tachyons.css">
    <link rel="stylesheet" href="/css/extrastyles.css">
        <script>
        // if (location.protocol != 'https:')
        // {
        //  location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
        // }
    </script>
    <script type="text/javascript"
    src="//media.twiliocdn.com/sdk/js/client/v1.7/twilio.min.js"></script>    
    <script type="text/javascript"
      src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js">
    </script>

  <style>
    .cf:before, .cf:after {
    content: " ";
    display: table;
}
.cf:after {
    clear: both;
}
.cf {
    *zoom: 1;
}
.fl {
    float: left;
    display: inline;
}
.w-100 {
    width: 100%;
}
.bg-light-gray {
    background-color: #eee;
}
.bg-near-white {
    background-color: #f4f4f4;
}
.tc {
    text-align: center;
}
@media screen and (min-width: 30em) {
    .w-50-ns {
        width: 50%;
    }
}
</style>
    <script type="text/javascript">
    {%block dialer %}
/**
 * Twilio Client configuration for the browser-calls-django
 * example application.
 */

// Store some selectors for elements we'll reuse
var callStatus = $("#call-status");
var answerButton = $(".answer-button");
var callSupportButton = $(".call-support-button");
var hangUpButton = $(".hangup-button");
var callCustomerButtons = $(".call-customer-button");

/* Helper function to update the call status bar */
function updateCallStatus(status) {
    callStatus.text(status);
}

/* Get a Twilio Client token with an AJAX request */
$(document).ready(function() {
    $.get("/token", {forPage: window.location.pathname}, function(data) {
        // Set up the Twilio Client Device with the token
        Twilio.Device.setup(data.token);
    });
});

/* Callback to let us know Twilio Client is ready */
    Twilio.Device.ready(function (device) {
        updateCallStatus("Ready");
    });

    /* Report any errors to the call status display */
    Twilio.Device.error(function (error) {
        updateCallStatus("ERROR: " + error.message);
    });

    // /* Callback for when Twilio Client initiates a new connection */
    // Twilio.Device.connect(function (connection) {
    //     // Enable the hang up button and disable the call buttons
    //     hangUpButton.prop("disabled", false);
    //     callCustomerButtons.prop("disabled", true);
    //     callSupportButton.prop("disabled", true);
    //     answerButton.prop("disabled", true);

    //     // If phoneNumber is part of the connection, this is a call from a
    //     // support agent to a customer's phone
    //     if ("phoneNumber" in connection.message) {
    //         updateCallStatus("In call with " + connection.message.phoneNumber);
    //     } else {
    //         // This is a call from a website user to a support agent
    //         updateCallStatus("In call with support");
    //     }
    // });

    // /* Callback for when a call ends */
    // Twilio.Device.disconnect(function(connection) {
    //     // Disable the hangup button and enable the call buttons
    //     hangUpButton.prop("disabled", true);
    //     callCustomerButtons.prop("disabled", false);
    //     callSupportButton.prop("disabled", false);

    //     updateCallStatus("Ready");
    // });

    // /* Call a customer from a support ticket */
    // function callCustomer({{ number }}) {
    //     updateCallStatus("Calling " + {{ number }} + "...");

    //     var params = {"phoneNumber": {{ number }}};
    //     Twilio.Device.connect(params);
    // }

    // /* End a call */
    // function hangUp() {
    //     Twilio.Device.disconnectAll();
    // }
    // Twilio.Device.setup("{{ token }}", {debug: true});

      Twilio.Device.ready(function (device) {
        $("#log").text("Ready to Call {{ name }}");
      });
    Twilio.Device.ready(function (device) {
        updateCallStatus("Ready");
    });
      Twilio.Device.error(function (error) {
        $("#log").text("Error: " + error.message);
      });

      Twilio.Device.connect(function (conn) {
        $("#log").text("Connected to the office of {{ name }}");
      });

      Twilio.Device.disconnect(function (conn) {
        $("#log").text("Call ended");
      });

      Twilio.Device.incoming(function (conn) {
        $("#log").text("Incoming connection from " + conn.parameters.From);
        // accept the incoming connection and start two-way audio
        conn.accept();
      });



      function call() {
        // get the phone number to connect the call to
        params = {"PhoneNumber": "{{ number }}"};
        Twilio.Device.connect(params);
      }

      function hangup() {
        Twilio.Device.disconnectAll();
      }

      {%endblock%}
    </script>
  </head>
<body class="w-100 sans-serif">
    <main>

      <section class="phm phl-ns mw7 center pvxl">
        {%block callheading %}
        <h2 class='ttu tracked'>Call {{ name }}</h2>
        <img class="center" src="{{photo}}" /><br />
        <button class='f5 f4-ns dim dib mtl br2 bg-white-10 ba b-red-40 blue-80 link pam call' class="call-customer-button" onclick="call();">
          Call {{ unformatted_number }}
        </button>
        <button class='f5 f4-ns dim dib mtl br2 bg-white-10 ba b-red-40 blue-80 link pam hangup' class="hangup-button" onclick="hangup();">
          Hangup
        </button>

        {%endblock%}
        <br /><br />
        <div id="log"></div>
        </section>
        </main>

      </body>
    </html>
