<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <title>
      Call Your Representatives!
    </title>
    <script>
        // if (location.protocol != 'https:')
        // {
        //  location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
        // }
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://josephmarhee.com/assets/tachyons.css">
    <script type="text/javascript"
    src="https://media.twiliocdn.com/sdk/js/client/v1.3/twilio.min.js"></script>    
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js">
    </script>
    <script type="text/javascript">
    {%block dialer %}
        /**
         * Twilio Client configuration for the browser-calls-django
         * example application.
         */

        // Store some selectors for elements we'll reuse
        var callStatus = $("#call-status");
        var answerButton = $(".answer-button");
        var callSupportButton = $(".call-support-button");
        var hangUpButton = $(".hangup-button");
        var callCustomerButtons = $(".call-customer-button");

        /* Helper function to update the call status bar */
        function updateCallStatus(status) {
            callStatus.text(status);
        }

        /* Get a Twilio Client token with an AJAX request */
        $(document).ready(function() {
            $.get("/support/token", {forPage: window.location.pathname}, function(data) {
                // Set up the Twilio Client Device with the token
                Twilio.Device.setup("{ 'token':" + data.token + "}");
            });
        });

    // /* Callback to let us know Twilio Client is ready */
    //     Twilio.Device.ready(function (device) {
    //         updateCallStatus("Ready");
    //     });

    //     /* Report any errors to the call status display */
    //     Twilio.Device.error(function (error) {
    //         updateCallStatus("ERROR: " + error.message);
    //     });

    //     /* Callback for when Twilio Client initiates a new connection */
    //     Twilio.Device.connect(function (connection) {
    //         // Enable the hang up button and disable the call buttons
    //         hangUpButton.prop("disabled", false);
    //         callCustomerButtons.prop("disabled", true);
    //         callSupportButton.prop("disabled", true);
    //         answerButton.prop("disabled", true);

    //         // If phoneNumber is part of the connection, this is a call from a
    //         // support agent to a customer's phone
    //         if ("phoneNumber" in connection.message) {
    //             updateCallStatus("In call with " + connection.message.phoneNumber);
    //         } else {
    //             // This is a call from a website user to a support agent
    //             updateCallStatus("In call with support");
    //         }
    //     });

    //     /* Callback for when a call ends */
    //     Twilio.Device.disconnect(function(connection) {
    //         // Disable the hangup button and enable the call buttons
    //         hangUpButton.prop("disabled", true);
    //         callCustomerButtons.prop("disabled", false);
    //         callSupportButton.prop("disabled", false);

    //         updateCallStatus("Ready");
    //     });

    //     /* Call a customer from a support ticket */
    //     function call(number) {
    //         updateCallStatus("Calling " + number + "...");

    //         var params = {"phoneNumber": number};
    //         Twilio.Device.connect(params);
    //     }

    //     /* End a call */
    //     function hangup() {
    //         Twilio.Device.disconnectAll();
    //     }
    //     // Twilio.Device.setup("{{ token }}", {debug: true});

    //       Twilio.Device.ready(function (device) {
    //         $("#log").text("Ready to Call {{ name }}");
    //       });
        Twilio.Device.ready(function (device) {
            updateCallStatus("Ready");
        });
          Twilio.Device.error(function (error) {
            $("#log").text("Error: " + error.message);
          });

          Twilio.Device.connect(function (conn) {
            $("#log").text("Connected to the office of {{ name }}");
          });

          Twilio.Device.disconnect(function (conn) {
            $("#log").text("Call ended");
          });

          Twilio.Device.incoming(function (conn) {
            $("#log").text("Incoming connection from " + conn.parameters.From);
            // accept the incoming connection and start two-way audio
            conn.accept();
          });



          function call() {
            // get the phone number to connect the call to
            params = {"PhoneNumber": "{{ number }}"};
            Twilio.Device.connect(params);
          }

          function hangup() {
            Twilio.Device.disconnectAll();
          }

    {%endblock%}
    </script>
    <div id="fb-root"></div>

</head>

<body class="w-100 sans-serif">
    <main>

        <section class="phm phl-ns mw7 center pvxl">
            {%block heading %}
                <h2 class='ttu tracked'>Representatives serving {{location['name']}}, {{zipCode}}...</h2>
            {% endblock %}

            {%for r in representatives %}
                <p class='f4 f3-ns lh-copy measure'>Your area is represented by <a href="{{r['urls']}}">{{r['name']}}</a> ({{r['party']}}) as your {{ r['office'] }}.</p>
                <button class='f5 f4-ns dim dib mtl br2 bg-white-10 ba b-red-40 blue-80 link pam call call-customer-button' onclick="call('{{number}}');">
                    Call {{ unformatted_number }}
                </button>
                <button class='f5 f4-ns dim dib mtl br2 bg-white-10 ba b-red-40 blue-80 link pam hangup hangup-button' onclick="hangup();">
                    Hangup
                </button>
                <br /><br /><hr /><br />
            {%endfor%}
        </section>
  </main>

</body>
